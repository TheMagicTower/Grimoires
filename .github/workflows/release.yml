name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create version file
        run: echo "${{ steps.version.outputs.VERSION }}" > version

      - name: Make release script executable
        run: chmod +x scripts/release.sh

      - name: Create release packages
        run: ./scripts/release.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Grimoires v${{ steps.version.outputs.VERSION }}
          body: |
            ## Grimoires v${{ steps.version.outputs.VERSION }}

            Multi-AI Agent Orchestration for Claude Code

            ### Installation

            **Unix/Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/bluelucifer/Grimoires/main/scripts/install.sh | bash
            ```

            **Windows PowerShell:**
            ```powershell
            irm https://raw.githubusercontent.com/bluelucifer/Grimoires/main/scripts/install.ps1 | iex
            ```

            **Windows CMD:**
            ```batch
            curl -fsSL https://raw.githubusercontent.com/bluelucifer/Grimoires/main/scripts/install.cmd -o install.cmd && install.cmd && del install.cmd
            ```

            ### What's New

            See [CHANGELOG.md](https://github.com/bluelucifer/Grimoires/blob/main/CHANGELOG.md) for details.

            ### Quick Start

            1. Install Grimoires using one of the commands above
            2. Open Claude Code in your project directory
            3. Run `/cast:summon` to initialize Grimoires
            4. Use `/cast:dev` to start development workflow

            ### Documentation

            - [Quick Start Guide](https://github.com/bluelucifer/Grimoires/blob/main/docs/QUICKSTART.md)
            - [Architecture](https://github.com/bluelucifer/Grimoires/blob/main/docs/ARCHITECTURE.md)

          files: |
            dist/grimoires-core.tar.gz
            dist/grimoires-core.zip
            dist/install.sh
            dist/install.ps1
            dist/install.cmd
            dist/uninstall.sh
            dist/uninstall.ps1
            dist/checksums.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Verify installation works
  test-install:
    name: Test Installation
    needs: release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test Unix installation
        if: runner.os != 'Windows'
        run: |
          curl -fsSL https://raw.githubusercontent.com/bluelucifer/Grimoires/main/scripts/install.sh | bash
          # Set PATH directly instead of sourcing rc files (more reliable in CI)
          export GRIMOIRES_HOME="$HOME/.grimoires"
          export PATH="$GRIMOIRES_HOME/bin:$PATH"
          grimoires version
          grimoires doctor

      - name: Test Windows installation
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          irm https://raw.githubusercontent.com/bluelucifer/Grimoires/main/scripts/install.ps1 | iex
          # Set PATH directly for current session
          $env:GRIMOIRES_HOME = "$env:USERPROFILE\.grimoires"
          $env:Path = "$env:GRIMOIRES_HOME\bin;$env:Path"
          grimoires version
          grimoires doctor
