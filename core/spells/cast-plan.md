# /cast:plan Spell

복잡한 작업을 위한 계획 수립 마법입니다. Sequential Thinking을 활용하여 체계적인 실행 계획을 생성합니다.

---

## Usage

```
/cast:plan "복잡한 기능 구현"
/cast:plan --analyze="인증 시스템 리팩토링"
/cast:plan --from-issue=PROJ-123
/cast:plan --depth=deep            # 상세 분석
/cast:plan --format=checklist      # 체크리스트 형식
```

---

## 1. Overview

복잡한 작업은 체계적인 계획이 필요합니다. `/cast:plan`은 Sequential Thinking MCP를 활용하여 6단계 분석을 수행합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    PLANNING WORKFLOW                             │
│                                                                  │
│   /cast:plan "작업 설명"                                         │
│        │                                                         │
│        ▼                                                         │
│   ┌───────────────────────────────────────────────────────┐     │
│   │           SEQUENTIAL THINKING (6 Steps)                │     │
│   │                                                        │     │
│   │   1. DEFINE     문제 정의 및 범위 설정                  │     │
│   │        │                                               │     │
│   │        ▼                                               │     │
│   │   2. DECOMPOSE  하위 작업으로 분해                      │     │
│   │        │                                               │     │
│   │        ▼                                               │     │
│   │   3. ANALYZE    각 작업 분석 및 의존성 파악             │     │
│   │        │                                               │     │
│   │        ▼                                               │     │
│   │   4. EVALUATE   접근 방법 평가 및 비교                  │     │
│   │        │                                               │     │
│   │        ▼                                               │     │
│   │   5. DECIDE     최적 방법 선택                          │     │
│   │        │                                               │     │
│   │        ▼                                               │     │
│   │   6. PLAN       실행 계획 수립                          │     │
│   │                                                        │     │
│   └───────────────────────────────────────────────────────┘     │
│        │                                                         │
│        ▼                                                         │
│   ┌───────────────────────────────────────────────────────┐     │
│   │              OUTPUT: Execution Plan                    │     │
│   │   - 단계별 작업 목록                                   │     │
│   │   - 의존성 그래프                                      │     │
│   │   - 리스크 평가                                        │     │
│   │   - 체크리스트                                         │     │
│   └───────────────────────────────────────────────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Sequential Thinking Steps

### Step 1: DEFINE

```
┌─────────────────────────────────────────────────────────────────┐
│                        DEFINE                                    │
│                                                                  │
│   Input: "사용자 인증 시스템을 OAuth로 마이그레이션"              │
│                                                                  │
│   Analysis:                                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ Problem Statement:                                       │   │
│   │ 현재 세션 기반 인증을 OAuth 2.0으로 변경                  │   │
│   │                                                          │   │
│   │ Scope:                                                   │   │
│   │ - In: OAuth 제공자 연동, 토큰 관리, 사용자 마이그레이션   │   │
│   │ - Out: UI 변경, 권한 시스템 변경                         │   │
│   │                                                          │   │
│   │ Success Criteria:                                        │   │
│   │ - 기존 사용자 로그인 유지                                 │   │
│   │ - 새 OAuth 로그인 작동                                   │   │
│   │ - 기존 세션 점진적 만료                                  │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Step 2: DECOMPOSE

```
┌─────────────────────────────────────────────────────────────────┐
│                       DECOMPOSE                                  │
│                                                                  │
│   Main Task: OAuth Migration                                     │
│        │                                                         │
│        ├── 1. OAuth 제공자 설정                                  │
│        │   ├── 1.1 Google OAuth 설정                             │
│        │   ├── 1.2 GitHub OAuth 설정                             │
│        │   └── 1.3 환경 변수 구성                                │
│        │                                                         │
│        ├── 2. 인증 서비스 구현                                   │
│        │   ├── 2.1 OAuth 클라이언트 통합                         │
│        │   ├── 2.2 토큰 관리 서비스                              │
│        │   └── 2.3 사용자 연결 로직                              │
│        │                                                         │
│        ├── 3. 데이터베이스 변경                                  │
│        │   ├── 3.1 스키마 마이그레이션                           │
│        │   └── 3.2 기존 사용자 데이터 매핑                       │
│        │                                                         │
│        ├── 4. API 엔드포인트 수정                                │
│        │   ├── 4.1 로그인 엔드포인트                             │
│        │   ├── 4.2 콜백 엔드포인트                               │
│        │   └── 4.3 토큰 갱신 엔드포인트                          │
│        │                                                         │
│        └── 5. 테스트 및 마이그레이션                             │
│            ├── 5.1 단위 테스트                                   │
│            ├── 5.2 통합 테스트                                   │
│            └── 5.3 점진적 롤아웃                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Step 3: ANALYZE

```
┌─────────────────────────────────────────────────────────────────┐
│                        ANALYZE                                   │
│                                                                  │
│   Dependency Graph:                                              │
│                                                                  │
│   1.1 ──┐                                                        │
│   1.2 ──┼── 1.3 ── 2.1 ──┬── 2.2 ── 2.3 ── 4.1                  │
│         │                │                   │                   │
│         │                │                   ├── 4.2             │
│         │                │                   │                   │
│         │                └── 3.1 ── 3.2 ─────┴── 4.3             │
│         │                                                        │
│         └────────────────────────────────────────── 5.x         │
│                                                                  │
│   Risk Analysis:                                                 │
│   ┌────────────┬──────────┬───────────────────────────────┐     │
│   │ Task       │ Risk     │ Mitigation                    │     │
│   ├────────────┼──────────┼───────────────────────────────┤     │
│   │ 3.1 Schema │ High     │ Backup, reversible migration  │     │
│   │ 3.2 Data   │ Medium   │ Dry run, rollback plan        │     │
│   │ 5.3 Rollout│ High     │ Feature flag, gradual %       │     │
│   └────────────┴──────────┴───────────────────────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Step 4: EVALUATE

```
┌─────────────────────────────────────────────────────────────────┐
│                        EVALUATE                                  │
│                                                                  │
│   Approach Options:                                              │
│                                                                  │
│   Option A: Big Bang Migration                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ + 단순한 구현                                            │   │
│   │ + 한 번에 완료                                           │   │
│   │ - 높은 리스크                                            │   │
│   │ - 롤백 어려움                                            │   │
│   │ Score: 3/10                                              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   Option B: Gradual Migration with Feature Flag                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ + 낮은 리스크                                            │   │
│   │ + 점진적 롤아웃                                          │   │
│   │ + 쉬운 롤백                                              │   │
│   │ - 두 시스템 유지 필요                                    │   │
│   │ Score: 8/10 ⭐ Recommended                               │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   Option C: Parallel Run with Sync                               │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ + 검증 가능                                              │   │
│   │ - 복잡한 구현                                            │   │
│   │ - 데이터 동기화 문제                                     │   │
│   │ Score: 5/10                                              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Step 5: DECIDE

```
┌─────────────────────────────────────────────────────────────────┐
│                         DECIDE                                   │
│                                                                  │
│   Selected: Option B - Gradual Migration with Feature Flag       │
│                                                                  │
│   Rationale:                                                     │
│   - 프로덕션 안정성 유지                                         │
│   - 문제 발생 시 빠른 롤백                                       │
│   - 사용자 영향 최소화                                           │
│                                                                  │
│   Trade-offs Accepted:                                           │
│   - 두 인증 시스템 병행 유지 (약 2주)                            │
│   - 추가 테스트 필요                                             │
│                                                                  │
│   Feature Flag Strategy:                                         │
│   - 10% → 25% → 50% → 100% (각 단계 2일)                        │
│   - 에러율 2% 초과 시 자동 롤백                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Step 6: PLAN

```
┌─────────────────────────────────────────────────────────────────┐
│                          PLAN                                    │
│                                                                  │
│   Execution Plan                                                 │
│                                                                  │
│   Phase 1: 준비 (Day 1-2)                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ □ OAuth 제공자 등록 (Google, GitHub)                     │   │
│   │ □ 환경 변수 설정                                         │   │
│   │ □ Feature flag 인프라 구성                               │   │
│   │ □ DB 마이그레이션 스크립트 작성                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   Phase 2: 구현 (Day 3-5)                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ □ OAuth 클라이언트 통합                                  │   │
│   │ □ 토큰 관리 서비스                                       │   │
│   │ □ API 엔드포인트 구현                                    │   │
│   │ □ 사용자 연결 로직                                       │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   Phase 3: 테스트 (Day 6-7)                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ □ 단위 테스트 작성                                       │   │
│   │ □ 통합 테스트 작성                                       │   │
│   │ □ E2E 테스트 작성                                        │   │
│   │ □ 부하 테스트                                            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   Phase 4: 롤아웃 (Day 8-14)                                     │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ □ 10% 롤아웃, 모니터링                                   │   │
│   │ □ 25% 롤아웃                                             │   │
│   │ □ 50% 롤아웃                                             │   │
│   │ □ 100% 롤아웃                                            │   │
│   │ □ 레거시 코드 제거                                       │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Output Formats

### 3.1 Checklist Format (`--format=checklist`)

```markdown
## OAuth Migration Checklist

### Phase 1: 준비
- [ ] Google OAuth 앱 등록
- [ ] GitHub OAuth 앱 등록
- [ ] 환경 변수 설정 (.env.example 업데이트)
- [ ] Feature flag 설정 (LaunchDarkly/자체 구현)
- [ ] DB 마이그레이션 PR 생성

### Phase 2: 구현
- [ ] `src/auth/oauth-client.ts` 구현
- [ ] `src/auth/token-service.ts` 구현
- [ ] `src/api/auth/callback.ts` 엔드포인트
- [ ] `src/api/auth/refresh.ts` 엔드포인트
- [ ] 사용자 연결 로직

### Phase 3: 테스트
- [ ] OAuth 클라이언트 단위 테스트
- [ ] 토큰 갱신 통합 테스트
- [ ] 로그인 플로우 E2E 테스트

### Phase 4: 롤아웃
- [ ] 10% 롤아웃 (모니터링 2일)
- [ ] 25% 롤아웃
- [ ] 50% 롤아웃
- [ ] 100% 롤아웃
- [ ] 레거시 인증 코드 제거
```

### 3.2 Dependency Graph Format

```
graph TD
    A[OAuth 제공자 설정] --> B[OAuth 클라이언트 통합]
    B --> C[토큰 관리 서비스]
    C --> D[API 엔드포인트]

    E[DB 스키마 마이그레이션] --> F[데이터 매핑]
    F --> D

    D --> G[단위 테스트]
    D --> H[통합 테스트]
    G --> I[롤아웃]
    H --> I
```

### 3.3 Risk Matrix

```
| Task                    | Impact | Probability | Risk Score | Mitigation                  |
|-------------------------|--------|-------------|------------|-----------------------------|
| DB Schema Migration     | High   | Medium      | 6          | Backup, dry-run            |
| Token Migration         | High   | Low         | 4          | Parallel validation        |
| Feature Flag Rollout    | Medium | Medium      | 4          | Gradual %, auto-rollback   |
| Legacy Code Removal     | Low    | Low         | 2          | Feature flag first         |
```

---

## 4. Options

| Option | Description | Default |
|--------|-------------|---------|
| `--depth` | 분석 깊이 (shallow/normal/deep) | normal |
| `--format` | 출력 형식 (full/checklist/diagram) | full |
| `--from-issue` | 이슈에서 요구사항 추출 | - |
| `--save` | 계획을 파일로 저장 | false |
| `--interactive` | 대화형 모드 | false |

---

## 5. Integration

### 5.1 With Serena Memory

```
계획 결과는 Serena 메모리에 저장:
.serena/memories/current-task.md
```

### 5.2 With /cast:dev

```
/cast:plan "새 기능 구현" → 계획 수립
/cast:dev → 계획에 따라 구현
```

---

## 6. Related Spells

| Spell | Description |
|-------|-------------|
| `/cast:dev` | 개발 워크플로우 |
| `/cast:refactor` | 리팩토링 |
| `/cast:analyze` | 코드 분석 |

---

*Version: 0.3.0*
*Last Updated: 2026-01-26*
